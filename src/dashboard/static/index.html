<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HYDRA Command Center</title>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Xterm.js -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    
    <style>
        :root { --bg: #0d1117; --card: #161b22; --accent: #2f81f7; --text: #c9d1d9; --border: #30363d; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', monospace; margin: 0; padding: 20px; display: grid; grid-template-columns: 300px 1fr; gap: 20px; height: 100vh; box-sizing: border-box; }
        
        .sidebar { display: flex; flex-direction: column; gap: 20px; }
        .main { display: flex; flex-direction: column; gap: 20px; overflow: hidden; }
        
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 15px; }
        .card h3 { margin-top: 0; color: var(--accent); border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        
        .metric { font-size: 24px; font-weight: bold; }
        .metric-label { font-size: 12px; color: #8b949e; }
        
        #terminal-container { flex: 1; background: #000; padding: 10px; border-radius: 6px; overflow: hidden; }
        
        .status-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
        .online { background: #238636; box-shadow: 0 0 8px #238636; }
        .offline { background: #da3633; }

        canvas { max-height: 150px; }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="card">
            <h3>üê∫ HYDRA Status</h3>
            <div id="status-indicator"><span class="status-dot offline"></span> Connecting...</div>
            <div style="margin-top: 15px;">
                <div class="metric" id="uptime">0s</div>
                <div class="metric-label">UPTIME</div>
            </div>
            <div style="margin-top: 10px;">
                <div class="metric" id="version">-</div>
                <div class="metric-label">VERSION</div>
            </div>
        </div>

        <div class="card">
            <h3>System Resources</h3>
            <canvas id="resourceChart"></canvas>
            <div style="margin-top: 10px; display: flex; justify-content: space-between;">
                <div>
                    <div class="metric" id="cpu-val">0%</div>
                    <div class="metric-label">CPU</div>
                </div>
                <div>
                    <div class="metric" id="ram-val">0GB</div>
                    <div class="metric-label">RAM</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main">
        <div class="card" style="flex: 1; display: flex; flex-direction: column;">
            <h3>Audit Logs (Tail)</h3>
            <div id="terminal-container"></div>
        </div>
    </div>

    <script>
        // --- Xterm Setup ---
        const term = new Terminal({
            theme: { background: '#000000', foreground: '#00ff00' },
            fontFamily: 'Consolas, monospace',
            fontSize: 14,
            convertEol: true
        });
        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(document.getElementById('terminal-container'));
        fitAddon.fit();
        window.addEventListener('resize', () => fitAddon.fit());

        // --- Chart Setup ---
        const ctx = document.getElementById('resourceChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array(20).fill(''),
                datasets: [{
                    label: 'CPU %',
                    borderColor: '#2f81f7',
                    data: Array(20).fill(0),
                    tension: 0.4,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { min: 0, max: 100, grid: { display: false } }, x: { display: false } },
                plugins: { legend: { display: false } }
            }
        });

        // --- Data Fetching ---
        async function updateDashboard() {
            try {
                // 1. Status
                const statusRes = await fetch('/api/status');
                const statusData = await statusRes.json();
                document.getElementById('status-indicator').innerHTML = `<span class="status-dot online"></span> ${statusData.status}`;
                document.getElementById('version').innerText = statusData.version;

                // 2. System Stats
                const sysRes = await fetch('/api/system');
                const sysData = await sysRes.json();
                
                document.getElementById('uptime').innerText = Math.floor(sysData.uptime / 60) + "m";
                document.getElementById('cpu-val').innerText = sysData.cpu_usage.toFixed(1) + "%";
                document.getElementById('ram-val').innerText = (sysData.memory_used / 1024 / 1024 / 1024).toFixed(1) + " GB";

                // Update Chart
                chart.data.datasets[0].data.push(sysData.cpu_usage);
                chart.data.datasets[0].data.shift();
                chart.update();

                // 3. Logs
                const logRes = await fetch('/api/logs');
                const logs = await logRes.text();
                term.clear();
                term.write(logs.replace(/\n/g, '\r\n'));

            } catch (e) {
                document.getElementById('status-indicator').innerHTML = `<span class="status-dot offline"></span> Disconnected`;
            }
        }

        setInterval(updateDashboard, 2000);
        updateDashboard();
    </script>
</body>
</html>